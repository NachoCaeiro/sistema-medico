<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tablero de Control Médico</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
</head>
<body>
  <header class="main-app-header">
    <h1>Tablero de Control Médico</h1>
    <div class="logout-link">
      ¡Bienvenido, {{ session.username }}! <a href="{{ url_for('logout') }}">Cerrar Sesión</a>
    </div>
  </header>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flash-messages">
        {% for category, message in messages %}
          <li class="alert alert-{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    {% endwith %}

    <!-- FILTROS -->
    <section id="filters">
      <h2>Filtros</h2>
      <form method="get" action="{{ url_for('home') }}">
        <div>
          <label for="search_company_name">Buscar por Nombre de Empresa:</label>
          <input
            type="text"
            id="search_company_name"
            name="search_company_name"
            value="{{ search_company_name_value if search_company_name_value else '' }}"
          />
        </div>
        <div>
          <label for="search_patient_document">Buscar por Documento del Paciente:</label>
          <input
            type="text"
            id="search_patient_document"
            name="search_patient_document"
            value="{{ search_patient_document_value if search_patient_document_value else '' }}"
            pattern="\d+"
            title="Ingrese solo números"
            inputmode="numeric"
            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          />
        </div>
        <button type="submit" class="btn">Aplicar Filtros</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ url_for('home') }}'">Limpiar Filtros</button>
      </form>
    </section>

    <!-- ACCIONES -->
    <section id="actions">
      <h2>Acciones</h2>
      <button class="btn" onclick="location.href='{{ url_for('add_company') }}'">Agregar Nueva Empresa</button>
      <button class="btn" onclick="location.href='{{ url_for('add_patient') }}'">Agregar Nuevo Paciente</button>
      <button class="btn" onclick="location.href='{{ url_for('add_medical_record') }}'">Agregar Visita Médica (General)</button>
      <button class="btn" onclick="location.href='{{ url_for('select_companies_for_daily_send') }}'">Enviar Registros del Día</button>
    </section>

    <!-- HISTORIAL (MOVIDO DEBAJO DE ACCIONES) -->
    <section id="medical-history">
      <h2>Historia Clínica del Paciente</h2>
      {% if selected_patient %}
        <h3 id="hist-anchor">
          Historial de: {{ selected_patient.name }} {{ selected_patient.surname }} (Doc: {{ selected_patient.document_number }})
        </h3>
        <p>Empresa: {{ selected_patient.company_name if selected_patient.company_name else 'N/A' }}</p>

        <button class="btn" onclick="location.href='{{ url_for('add_medical_record_for_patient', patient_id=selected_patient.id) }}'">
          Agregar Nueva Visita para {{ selected_patient.name }}
        </button>

        {% if medical_history %}
          <ul class="item-list">
            {% for record in medical_history %}
              <li class="action-item">
                <div>
                  <strong>Fecha:</strong> {{ record.date }}<br>
                  <strong>Compañía en Visita:</strong> {{ record.company_name }}<br>
                  <strong>Diagnóstico:</strong><br>
                  <pre>{{ record.diagnosis }}</pre>
                </div>
                <div style="margin-top: 0.5em;">
                  <a href="{{ url_for('edit_medical_record', record_id=record.id) }}" class="btn btn-secondary">Editar Registro</a>
                  <form action="{{ url_for('delete_medical_record', record_id=record.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('¿Está seguro que desea eliminar este registro médico?');">
                      Eliminar Registro
                    </button>
                  </form>
                  <a href="{{ url_for('download_medical_record_pdf', record_id=record.id) }}" target="_blank" class="btn btn-info">Ver PDF</a>
                  <form action="{{ url_for('email_medical_record', record_id=record.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-info" onclick="return confirm('¿Está seguro que desea enviar este informe por correo electrónico a la empresa asociada al paciente en este registro?');">
                      Enviar Email
                    </button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No se encontraron registros médicos para este paciente.</p>
        {% endif %}

      {% elif search_patient_document_value %}
        <p id="hist-anchor">Paciente con número de documento "{{ search_patient_document_value }}" no encontrado.</p>
      {% else %}
        <p>Buscar un paciente por número de documento para ver su historial, o haga clic en "Ver Historial" junto a un paciente en la lista.</p>
      {% endif %}
    </section>

    <!-- EMPRESAS -->
    <section id="companies-list">
      <h2>Lista de Empresas</h2>
      <ul class="item-list">
        {% for company in companies %}
          <li class="action-item">
            <div>
              {{ company.name }} - {{ company.email }} (ID: {{ company.id }})
            </div>
            <div style="margin-top: 0.5em;">
              <a href="{{ url_for('edit_company', company_id=company.id) }}" class="btn btn-secondary">Editar</a>
              <form action="{{ url_for('delete_company', company_id=company.id) }}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('¿Está seguro que desea eliminar esta empresa y todos sus pacientes y registros médicos asociados?');">
                  Eliminar
                </button>
              </form>
            </div>
          </li>
        {% endfor %}
      </ul>
    </section>

    <!-- PACIENTES -->
    <section id="patients-list">
      <h2>Lista de Pacientes</h2>
      <ul class="item-list">
        {% for patient_item in patients %}
          <li class="action-item">
            <div>
              {{ patient_item.name }} {{ patient_item.surname }} (Doc: {{ patient_item.document_number }}) - Empresa: {{ patient_item.company_name if patient_item.company_name else 'N/A' }}
            </div>
            <div style="margin-top: 0.5em;">
              <a href="{{ url_for('edit_patient', patient_id=patient_item.id) }}" class="btn btn-secondary">Editar</a>
              <form action="{{ url_for('delete_patient', patient_id=patient_item.id) }}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('¿Está seguro que desea eliminar este paciente y todos sus registros médicos asociados?');">
                  Eliminar
                </button>
              </form>
              <!-- Ancla para saltar directo al historial -->
              <a href="{{ url_for('home', search_patient_document=patient_item.document_number) }}#hist-anchor" class="btn btn-info">
                Ver Historial
              </a>
            </div>
          </li>
        {% endfor %}
      </ul>
    </section>
  </div>

  <script>
    // Mantener scroll manual
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }
    const scrollY = localStorage.getItem("scrollPos");
    if (scrollY) {
      window.scrollTo(0, parseInt(scrollY));
      localStorage.removeItem("scrollPos");
    }
    window.addEventListener("beforeunload", () => {
      localStorage.setItem("scrollPos", window.scrollY);
    });

    // Scroll suave al historial si corresponde
    document.addEventListener('DOMContentLoaded', () => {
      const hasSelected = {{ 'true' if selected_patient else 'false' }};
      const hasDocSearch = {{ 'true' if search_patient_document_value else 'false' }};
      if (location.hash === '#hist-anchor' || hasSelected || hasDocSearch) {
        const anchor = document.getElementById('hist-anchor');
        if (anchor) {
          anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    });
  </script>
</body>
</html>
